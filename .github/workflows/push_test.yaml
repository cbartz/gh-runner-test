name: CI
on: [push]
jobs:
  build:
    runs-on: [self-hosted, linux, arm64]
    steps:
    - uses: actions/checkout@v4
      with:
        repository: 'canonical/github-runner-operator'
        ref: 'ISD-1824-cos-integration-openstack'
    - name: temporary proxy fix
      run: |
        sudo snap install aproxy --channel edge --revision 9
        sudo snap set aproxy proxy=squid.internal:3128 listen=:54969
        sudo nft -f - << EOF
        define default-ip = $(ip route get $(ip route show 0.0.0.0/0 | grep -oP 'via \K\S+') | grep -oP 'src \K\S+')
        define private-ips = { 10.0.0.0/8, 127.0.0.1/8, 172.16.0.0/12, 192.168.0.0/16 }
        table ip aproxy
        flush table ip aproxy
        table ip aproxy {
              chain prerouting {
                      type nat hook prerouting priority dstnat; policy accept;
                      ip daddr != \$private-ips tcp dport { 80, 443 } counter dnat to \$default-ip:54969
              }
        
              chain output {
                      type nat hook output priority -100; policy accept;
                      ip daddr != \$private-ips tcp dport { 80, 443 } counter dnat to \$default-ip:54969
              }
        }
        EOF
    - name: Install dependencies
      run: |
          sudo snap install charmcraft --classic
          sudo lxd init --auto
          sudo usermod -a -G lxd $USER
    - name: Pack the charm
      run: |
          export http_proxy="" https_proxy="" HTTP_PROXY="" HTTPS_PROXY=""
          sg lxd -c "charmcraft pack"
    - name: upload artifact
      uses: actions/upload-artifact@v4
      with:
          name: charm
          path: ./*.charm
